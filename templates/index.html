<script>
  const verEl = document.getElementById("ver");
  const countEl = document.getElementById("count");
  const statusEl = document.getElementById("status");

  let es;

  function hardReload() {
    // recarrega com "cache buster"
    const url = window.location.pathname + "?v=" + Date.now();
    window.location.replace(url);
  }

  function connect() {
    es = new EventSource("/events");

    es.addEventListener("version", (e) => {
      verEl.textContent = e.data;
      statusEl.textContent = "conectado";
    });

    es.onmessage = (e) => {
      countEl.textContent = e.data;
    };

    es.onerror = () => {
      statusEl.textContent = "desconectado — aguardando nova versão…";
      es.close();

      // tenta reconectar após 1 segundo
      setTimeout(() => {
        statusEl.textContent = "nova versão detectada, recarregando…";
        hardReload();
      }, 1000);
    };
  }

  connect();
</script>
